[
    {
        "name": "Maximum Crossings (Hard Version)",
        "description": "The only difference between the two versions is that in this version \n    n\n    \n    \u2264 2 \n    \u00b7 10^5\n and the sum of \n    n\n over all test cases does not\nexceed \n    2 \n    \u00b7 10^5\n. A terminal is a row of \n    n\n equal segments\nnumbered \n    1\n to \n    n\n in order. There are two terminals, one above the\nother. You are given an array \n    a\n of length \n    n\n. For all \n    i = 1, 2,\n    \n    \u2026, n\n, there should be a straight wire from some point on segment\n\n    i\n of the top terminal to some point on segment \n    a_i\n of the bottom\nterminal. You can't select the endpoints of a segment. For example, the\nfollowing pictures show two possible wirings if \n    n=7\n and\n\n    a=[4,1,4,6,7,7,5]\n. A crossing occurs when two wires share a point in\ncommon. In the picture above, crossings are circled in red. What is the\nmaximum number of crossings there can be if you place the wires optimally?\nInput The first line contains an integer \n    t\n (\n    1 \n    \u2264 t \n    \u2264\n    1000\n) \u2014 the number of test cases. The first line of each test case contains\nan integer \n    n\n (\n    1 \n    \u2264 n \n    \u2264 2 \n    \u00b7 10^5\n) \u2014 the length of\nthe array. The second line of each test case contains \n    n\n integers \n    a_1,\n    a_2, \n    \u2026, a_n\n (\n    1 \n    \u2264 a_i \n    \u2264 n\n) \u2014 the elements of the\narray. The sum of \n    n\n across all test cases does not exceed \n    2 \n    \u00b7\n    10^5\n. Output For each test case, output a single integer \u2014 the maximum\nnumber of crossings there can be if you place the wires optimally. Example\nInput 4 7 4 1 4 6 7 7 5 2 2 1 1 1 3 2 2 2 Output 6 1 0 3 Note The first test\ncase is shown in the second picture in the statement. In the second test case,\nthe only wiring possible has the two wires cross, so the answer is \n    1\n. In\nthe third test case, the only wiring possible has one wire, so the answer is\n\n    0\n.\n\n",
        "cf_contest_id": 1676,
        "cf_index": "H2",
        "cf_rating": 1500,
        "difficulty": 0,
        "cf_tags": [
            "data structures",
            "divide and conquer",
            "sortings"
        ],
        "time_limit_seconds": 1.0,
        "memory_limit_bytes": 256.0,
        "public_cases": [
            [
                "4\r\n7\r\n4 1 4 6 7 7 5\r\n2\r\n2 1\r\n1\r\n1\r\n3\r\n2 2 2\r\n",
                "6\r\n1\r\n0\r\n3\r\n"
            ]
        ],
        "private_cases": []
    }
]